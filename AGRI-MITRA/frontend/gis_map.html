<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Map Analyzer - Interactive DSS</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #0a0a0a;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1800px;
    margin: 0 auto;
    background: #111;
    border-radius: 20px;
    box-shadow: 0 0 30px rgba(0, 255, 0, 0.1);
    overflow: hidden;
}

.header {
    /* Updated to match your AGRI-MITRA teal theme */
    background: #4DB6AC;
    color: white;
    padding: 30px;
    text-align: center;
}

.header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.main-content {
    display: flex;
    min-height: 85vh;
}

.controls {
    width: 300px;
    background: #1a1a1a;
    padding: 25px;
    border-right: 1px solid #2e2e2e;
    overflow-y: auto;
}

.map-container {
    flex: 1;
    position: relative;
    background: #121212;
    display: flex;
    flex-direction: column;
}

.file-upload {
    margin-bottom: 25px;
    padding: 15px;
    /* Updated to match your AGRI-MITRA orange theme */
    border: 2px dashed #FF7043;
    border-radius: 10px;
    text-align: center;
    background: rgba(255, 112, 67, 0.05);
    transition: all 0.3s ease;
}

.file-upload:hover {
    background: rgba(255, 112, 67, 0.1);
    border-color: #FF7043;
}

.file-upload input {
    display: none;
}

.upload-label {
    display: block;
    cursor: pointer;
    padding: 12px;
    /* Updated to match your AGRI-MITRA orange theme */
    background: #FF7043;
    color: #000;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.upload-label:hover {
    background: #E64A19;
    box-shadow: 0 0 8px #FF7043;
}

.legend {
    margin-top: 15px;
}

.legend h3 {
    color: #FF7043;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.highlight-info {
    background: rgba(255, 112, 67, 0.05);
    border: 1px solid #FF7043;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    font-size: 0.8rem;
    text-align: center;
    color: #ffccbc;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background: #1f1f1f;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    user-select: none;
    border: 2px solid transparent;
}

.legend-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(255, 112, 67, 0.2);
}

.legend-item.highlighted {
    background: linear-gradient(135deg, #FF7043, #E64A19);
    color: white;
    border-color: #FF7043;
    transform: translateX(8px);
    box-shadow: 0 0 15px #FF7043, 0 0 30px #FF7043cc;
}

.legend-item.highlighted .legend-text {
    color: white;
}

.legend-item.dimmed {
    opacity: 0.3;
    transform: none;
}

.color-box {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    margin-right: 12px;
    border: 2px solid rgba(255, 112, 67, 0.2);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.legend-item.highlighted .color-box {
    border-color: white;
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
}

.legend-text {
    font-weight: 600;
    color: #e0e0e0;
    transition: color 0.3s ease;
}

.clear-highlight {
    width: 100%;
    padding: 8px;
    background: #888;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.clear-highlight:hover:not(:disabled) {
    background: #999;
}

.clear-highlight:disabled {
    background: #444;
    color: #888;
    cursor: not-allowed;
    box-shadow: none;
}

.canvas-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px;
    position: relative;
    min-height: 600px;
}

#mapCanvas {
    max-width: 95%;
    max-height: 95%;
    min-width: 800px;
    min-height: 600px;
    border-radius: 15px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.15);
    background: black;
    image-rendering: pixelated;
    transition: transform 0.3s ease;
}

#mapCanvas:hover {
    transform: scale(1.05);
}

.info-panel {
    background: #1c1c1c;
    padding: 25px;
    margin: 25px;
    border-radius: 15px;
    display: none;
    max-height: 300px;
    overflow-y: auto;
    color: #eee;
}

.info-panel.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-top: 15px;
}

.stat-card {
    background: #222;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    color: #ccc;
    border: 1px solid #FF7043;
}

.stat-card.highlight-total {
    background: linear-gradient(135deg, #E64A19, #FF7043);
    color: white;
}

.stat-number {
    font-size: 1.3rem;
    font-weight: bold;
    color: #FF7043;
}

.stat-card.highlight-total .stat-number {
    color: white;
}

.placeholder-message {
    text-align: center;
    color: #aaa;
    font-size: 1.2rem;
    padding: 60px 20px;
}

.placeholder-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}

.processing-info {
    background: #222;
    border: 1px solid #4DB6AC;
    padding: 12px;
    margin-top: 15px;
    border-radius: 8px;
    font-size: 0.8rem;
    color: #ace0db;
}

.fullscreen-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    z-index: 1000;
    transition: all 0.3s ease;
}

.fullscreen-btn:hover {
    background: #4DB6AC;
}

.fullscreen-mode {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: black;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.fullscreen-mode canvas {
    max-width: 90vw;
    max-height: 90vh;
    min-width: unset;
    min-height: unset;
}

.recommendation-panel {
    margin-top: 25px;
    padding: 15px;
    background: #111;
    border: 2px solid #FF7043;
    border-radius: 12px;
    color: #ffccbc;
    font-size: 0.9rem;
    box-shadow: 0 0 15px #FF7043cc;
    max-height: 180px;
    overflow-y: auto;
    display: none;
}

.recommendation-panel.active {
    display: block;
}

.recommendation-panel strong {
    color: #FF7043;
    font-size: 1.1rem;
}

.recommendation-details {
    margin-top: 10px;
    line-height: 1.4;
    white-space: pre-wrap;
}

/* Scrollbar styling for controls and panels */
.controls::-webkit-scrollbar,
.recommendation-panel::-webkit-scrollbar,
.info-panel::-webkit-scrollbar {
    width: 8px;
}

.controls::-webkit-scrollbar-track,
.recommendation-panel::-webkit-scrollbar-track,
.info-panel::-webkit-scrollbar-track {
    background: #0a0a0a;
}

.controls::-webkit-scrollbar-thumb,
.recommendation-panel::-webkit-scrollbar-thumb,
.info-panel::-webkit-scrollbar-thumb {
    background: #4DB6AC;
    border-radius: 10px;
}

/* Responsive adjustments */
@media (max-width: 900px) {
    .main-content {
        flex-direction: column;
        min-height: auto;
    }

    .controls {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #2e2e2e;
        max-height: 300px;
        overflow-y: scroll;
    }

    .map-container {
        flex: none;
        height: 600px;
    }
}

/* Button focus outlines for accessibility */
.upload-label:focus,
.clear-highlight:focus,
.fullscreen-btn:focus,
.legend-item:focus {
    outline: 2px solid #FF7043;
    outline-offset: 2px;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Interactive Asset Map Analyzer</h1>
            <p>Upload your GeoTIFF file to get statistics and scheme recommendations</p>
        </div>

        <div class="main-content">
            <div class="controls">
                <div class="file-upload">
                    <input type="file" id="fileInput" accept=".tif,.tiff" />
                    <label for="fileInput" class="upload-label">
                        üìÅ Upload Asset Map TIFF
                    </label>
                </div>

                <div class="processing-info">
                    <strong>üìä Automatic Calculation (10m Resolution):</strong><br>
                    ‚Ä¢ Reads pixel values from GeoTIFF<br>
                    ‚Ä¢ Counts pixels per land cover class<br>
                    ‚Ä¢ Calculates area (1 pixel = 0.01 Hectares)<br>
                    ‚Ä¢ Sends stats to backend for DSS
                </div>

                <div class="legend">
                    <h3>üé® Interactive Land Cover Classes</h3>
                    <div class="highlight-info">
                        üí° Click on any class to highlight it on the map!
                    </div>
                    <!-- These colors are placeholders, the JS colorMap is used for the canvas -->
                    <div class="legend-item" data-class="0">
                        <div class="color-box" style="background-color: #000000;"></div>
                        <span class="legend-text">Background (0)</span>
                    </div>
                    <div class="legend-item" data-class="1">
                        <div class="color-box" style="background-color: #0077BE;"></div>
                        <span class="legend-text">Water Bodies (1)</span>
                    </div>
                    <div class="legend-item" data-class="2">
                        <div class="color-box" style="background-color: #228B22;"></div>
                        <span class="legend-text">Dense Forest (2)</span>
                    </div>
                    <div class="legend-item" data-class="3">
                        <div class="color-box" style="background-color: #90EE90;"></div>
                        <span class="legend-text">Agriculture (3)</span>
                    </div>
                    <div class="legend-item" data-class="4">
                        <div class="color-box" style="background-color: #FF0000;"></div>
                        <span class="legend-text">Built-up Areas (4)</span>
                    </div>
                    <div class="legend-item" data-class="5">
                        <div class="color-box" style="background-color: #D2B48C;"></div>
                        <span class="legend-text">Bare Soil (5)</span>
                    </div>
                    <div class="legend-item" data-class="6">
                        <div class="color-box" style="background-color: #FFD700;"></div>
                        <span class="legend-text">Sparse Vegetation (6)</span>
                    </div>
                    <button class="clear-highlight" id="clearHighlight" disabled>
                        üîÑ Clear Highlighting
                    </button>
                </div>
            </div>

            <div class="map-container">
                <div class="canvas-container" id="canvasContainer">
                    <div class="placeholder-message">
                        <div class="placeholder-icon">üó∫Ô∏è</div>
                        <h3>Upload your TIFF file for interactive analysis</h3>
                        <p>Click on legend items to highlight specific assets</p>
                    </div>
                </div>

                <div class="info-panel" id="infoPanel">
                    <h3>üìä Calculated Map Statistics</h3>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>

                <div class="recommendation-panel" id="recommendationPanel">
                    <h3>üéØ DSS Scheme Recommendation</h3>
                    <div id="schemeOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Backend API endpoint for the Decision Support System
        const DSS_API_URL = 'http://localhost:8000/api/dss/recommend';
        
        // Color mapping for visualization (RGB values)
        const colorMap = {
            0: [0, 0, 0],       // Background - Black
            1: [0, 119, 190],   // Water - Blue
            2: [34, 139, 34],   // Dense Forest - Forest Green
            3: [144, 238, 144], // Agriculture - Light Green
            4: [255, 0, 0],     // Built-up - Red
            5: [210, 180, 140], // Bare Soil - Tan
            6: [255, 215, 0]    // Sparse Vegetation - Gold
        };

        const classNames = {
            0: 'Background',
            1: 'Water Bodies',
            2: 'Dense Forest',
            3: 'Agriculture',
            4: 'Built-up Areas',
            5: 'Bare Soil',
            6: 'Sparse Vegetation'
        };

        // --- GLOBAL VARIABLES ---
        let originalClassificationData = null;
        let imageWidth = 0;
        let imageHeight = 0;
        let currentHighlightedClass = null;

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const canvasContainer = document.getElementById('canvasContainer');
        const infoPanel = document.getElementById('infoPanel');
        const statsGrid = document.getElementById('statsGrid');
        const clearHighlightBtn = document.getElementById('clearHighlight');
        const recommendationPanel = document.getElementById('recommendationPanel');
        const schemeOutput = document.getElementById('schemeOutput');

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleFileUpload);
        clearHighlightBtn.addEventListener('click', clearHighlighting);

        document.querySelectorAll('.legend-item').forEach(item => {
            item.addEventListener('click', function() {
                const classId = parseInt(this.getAttribute('data-class'));
                highlightClass(classId);
            });
        });

        // --- CORE FUNCTIONS ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            canvasContainer.innerHTML = '<div class="placeholder-message"><div class="placeholder-icon">‚è≥</div><h3>Processing TIFF file...</h3><p>Reading pixel data and calculating statistics...</p></div>';
            recommendationPanel.classList.remove('active');
            infoPanel.classList.remove('active');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
                const image = await tiff.getImage();
                const rasters = await image.readRasters();

                imageWidth = image.getWidth();
                imageHeight = image.getHeight();
                originalClassificationData = rasters[0]; // Assuming single band classification

                const stats = calculateStatistics(originalClassificationData);

                visualizeAssetMap(originalClassificationData, imageWidth, imageHeight);
                displayStatistics(stats);
                
                // *** UPDATED: Send stats to backend for DSS ***
                await getSchemeRecommendation(stats);

                clearHighlightBtn.disabled = false;

            } catch (error) {
                console.error('Error processing TIFF file:', error);
                canvasContainer.innerHTML = '<div class="placeholder-message"><div class="placeholder-icon">‚ùå</div><h3>Error reading TIFF file</h3><p>Please ensure you uploaded a valid GeoTIFF file.</p></div>';
            }
        }

        function highlightClass(classId) {
            if (!originalClassificationData) return;

            document.querySelectorAll('.legend-item').forEach(item => {
                const itemClassId = parseInt(item.getAttribute('data-class'));
                item.classList.remove('highlighted', 'dimmed');
                if (itemClassId === classId) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.add('dimmed');
                }
            });

            currentHighlightedClass = classId;
            visualizeAssetMapWithHighlight(originalClassificationData, imageWidth, imageHeight, classId);
        }

        function clearHighlighting() {
            if (!originalClassificationData) return;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('highlighted', 'dimmed');
            });
            currentHighlightedClass = null;
            visualizeAssetMap(originalClassificationData, imageWidth, imageHeight);
        }

        function visualizeAssetMap(data, width, height) {
            createVisualization(data, width, height, null);
        }

        function visualizeAssetMapWithHighlight(data, width, height, highlightClassId) {
            createVisualization(data, width, height, highlightClassId);
        }

        function createVisualization(data, width, height, highlightClassId = null) {
            let canvas = document.getElementById('mapCanvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.id = 'mapCanvas';
            }

            // --- Smart Scaling ---
            // Calculate scale to fit canvas inside container while maintaining aspect ratio
            const containerWidth = canvasContainer.clientWidth - 60; // 30px padding L/R
            const containerHeight = canvasContainer.clientHeight - 60; // 30px padding T/B
            
            // Calculate best scale based on width and height
            const scale = Math.min(containerWidth / width, containerHeight / height);
            
            canvas.width = width * scale;
            canvas.height = height * scale;
            
            // Adjust canvas style to be smaller if it's bigger than container
            canvas.style.width = `${canvas.width}px`;
            canvas.style.height = `${canvas.height}px`;
            canvas.style.minWidth = '0'; // Remove min-width/height from CSS
            canvas.style.minHeight = '0';


            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            // Create a temporary in-memory canvas at original resolution
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            const originalImageData = tempCtx.createImageData(width, height);

            for (let i = 0; i < data.length; i++) {
                const classValue = data[i];
                let color = colorMap[classValue] || [128, 128, 128]; // Default gray

                if (highlightClassId !== null) {
                    if (classValue === highlightClassId) {
                        // Make highlighted class brighter
                        color = color.map(c => Math.min(255, c + 50));
                    } else {
                        // Dim other classes
                        color = color.map(c => c * 0.3);
                    }
                }

                const pixelIndex = i * 4;
                originalImageData.data[pixelIndex] = color[0];     // R
                originalImageData.data[pixelIndex + 1] = color[1]; // G
                originalImageData.data[pixelIndex + 2] = color[2]; // B
                originalImageData.data[pixelIndex + 3] = 255;      // A
            }
            // Put the raw pixel data onto the temporary canvas
            tempCtx.putImageData(originalImageData, 0, 0);

            // Now, draw the temporary canvas onto the main (scaled) canvas
            // This performs a single, clean upscale/downscale operation
            ctx.drawImage(tempCanvas, 0, 0, width, height, 0, 0, canvas.width, canvas.height);
            
            // Add fullscreen button if it doesn't exist
            if (!document.getElementById('mapCanvas')) {
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.className = 'fullscreen-btn';
                fullscreenBtn.innerHTML = '‚õ∂ Fullscreen';
                fullscreenBtn.onclick = toggleFullscreen;

                canvasContainer.innerHTML = '';
                canvasContainer.style.position = 'relative';
                canvasContainer.appendChild(canvas);
                canvasContainer.appendChild(fullscreenBtn);
            }
        }
        
        function toggleFullscreen() {
            const canvas = document.getElementById('mapCanvas');
            if (!canvas) return;
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                 canvas.requestFullscreen();
            }
        }


        function calculateStatistics(data) {
            const pixelCounts = {};
            let totalPixels = 0;
            let validPixels = 0;

            for (let i = 0; i <= 6; i++) {
                pixelCounts[i] = 0;
            }

            for (let i = 0; i < data.length; i++) {
                const value = data[i];
                totalPixels++;
                if (value >= 0 && value <= 6) {
                    pixelCounts[value]++;
                    if (value > 0) validPixels++;
                }
            }

            const pixelAreaHa = 0.01; // 10m x 10m = 100sq.m = 0.01 Hectares
            const areas = {};
            let totalValidAreaHa = 0;

            for (let classId = 0; classId <= 6; classId++) {
                areas[classId] = {
                    pixels: pixelCounts[classId],
                    hectares: pixelCounts[classId] * pixelAreaHa,
                    percentage: 0
                };
                if (classId > 0) {
                    totalValidAreaHa += areas[classId].hectares;
                }
            }

            // Calculate percentage based on *valid* area (excluding background)
            for (let classId = 1; classId <= 6; classId++) {
                if (totalValidAreaHa > 0) {
                    areas[classId].percentage = (areas[classId].hectares / totalValidAreaHa) * 100;
                }
            }

            return {
                areas: areas,
                totalValidAreaHa: totalValidAreaHa,
                validPixels: validPixels,
            };
        }

        function displayStatistics(stats) {
            const statsHtml = `
                <div class="stat-card highlight-total" style="grid-column: 1 / -1;">
                    <div class="stat-number">${stats.totalValidAreaHa.toFixed(2)} ha</div>
                    <div>Total Classified Area</div>
                    <div style="opacity: 0.9; font-size: 0.8rem;">${stats.validPixels.toLocaleString()} pixels at 10m resolution</div>
                </div>
            ` + Object.keys(stats.areas)
                .filter(classId => classId > 0 && stats.areas[classId].hectares > 0)
                .sort((a, b) => stats.areas[b].hectares - stats.areas[a].hectares)
                .map(classId => {
                    const area = stats.areas[classId];
                    return `
                        <div class="stat-card">
                            <div class="stat-number">${area.hectares.toFixed(2)} ha</div>
                            <div style="font-size: 0.9rem;">${classNames[classId]}</div>
                            <div style="color: #666; font-size: 0.8rem;">${area.percentage.toFixed(1)}%</div>
                        </div>
                    `;
                }).join('');

            statsGrid.innerHTML = statsHtml;
            infoPanel.classList.add('active');
        }

        // --- *** UPDATED DSS FUNCTION *** ---
        // This function now sends stats to your Python backend
        async function getSchemeRecommendation(stats) {
            schemeOutput.innerHTML = '<p>Sending stats to DSS backend for analysis...</p>';
            recommendationPanel.classList.add('active');
            
            // Prepare the payload for your backend
            const payload = {
                agriculture_percent: stats.areas[3]?.percentage || 0,
                water_percent: stats.areas[1]?.percentage || 0,
                forest_percent: stats.areas[2]?.percentage || 0
            };

            try {
                // Send stats to your Python /api/dss/recommend endpoint
                const response = await fetch(DSS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Backend server error: ${response.statusText}`);
                }

                const recommendations = await response.json();
                
                // Format the recommendations from the backend
                let recommendationDetails = recommendations.map(rec => 
                    `‚Ä¢ <strong>${rec.scheme}:</strong> ${rec.reason}`
                ).join('<br><br>');

                schemeOutput.innerHTML = `
                    <strong>Backend DSS Analysis Complete:</strong>
                    <div class="recommendation-details">${recommendationDetails}</div>
                `;
                
            } catch (error) {
                console.error('Error fetching recommendation from backend:', error);
                schemeOutput.innerHTML = `
                    <strong>Error Connecting to DSS Backend</strong>
                    <div class="recommendation-details" style="color: #ff8a80;">
                        <p>Could not get recommendations. Is the backend server running?</p>
                        <p><strong>Details:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>